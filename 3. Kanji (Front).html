<!-- Fields used in this file: {{Vocabulary-Kana}}, {{Vocabulary-Kanji}}, {{Vocabulary-Pos}}, {{furigana:Sentence-Clozed}}, {{Vocabulary-English}} -->

<div id="kana" class="japanese" style="font-size:60px;">{{Vocabulary-Kana}}</div>
<script>
    // from https://github.com/lovell/hepburn
    function bulkReplace(str, regex, map) {
        if(arguments.length === 2) {
            map = regex;
            regex = new RegExp(Object.keys(map).join("|"), "ig");
        }
        return str.replace(regex, function(all) {
            if(all in map) {
                return map[all];
            }
            return all;
        });
    }
    var hiraganaMonographs = {
        "あ": "A", "い": "I", "う": "U", "え": "E", "お": "O",
        "か": "KA", "き": "KI", "く": "KU", "け": "KE", "こ": "KO",
        "さ": "SA", "し": "SHI", "す": "SU", "せ": "SE", "そ": "SO",
        "た": "TA", "ち": "CHI", "つ": "TSU", "て": "TE", "と": "TO",
        "な": "NA", "に": "NI", "ぬ": "NU", "ね": "NE", "の": "NO",
        "は": "HA", "ひ": "HI", "ふ": "FU", "へ": "HE", "ほ": "HO",
        "ま": "MA", "み": "MI", "む": "MU", "め": "ME", "も": "MO",
        "や": "YA", "ゆ": "YU", "よ": "YO",
        "ら": "RA", "り": "RI", "る": "RU", "れ": "RE", "ろ": "RO",
        "わ": "WA", "ゐ": "WI", "ゑ": "WE", "を": "WO", "ん": "N'",
        "が": "GA", "ぎ": "GI", "ぐ": "GU", "げ": "GE", "ご": "GO",
        "ざ": "ZA", "じ": "JI", "ず": "ZU", "ぜ": "ZE", "ぞ": "ZO",
        "だ": "DA", "ぢ": "DJI", "づ": "DZU", "で": "DE", "ど": "DO",
        "ば": "BA", "び": "BI", "ぶ": "BU", "べ": "BE", "ぼ": "BO",
        "ぱ": "PA", "ぴ": "PI", "ぷ": "PU", "ぺ": "PE", "ぽ": "PO"
    };
    var hiraganaDigraphs = {
        "きゃ": "KYA", "きゅ": "KYU", "きょ": "KYO",
        "しゃ": "SHA", "しゅ": "SHU", "しょ": "SHO",
        "ちゃ": "CHA", "ちゅ": "CHU", "ちょ": "CHO",
        "にゃ": "NYA", "にゅ": "NYU", "にょ": "NYO",
        "ひゃ": "HYA", "ひゅ": "HYU", "ひょ": "HYO",
        "みゃ": "MYA", "みゅ": "MYU", "みょ": "MYO",
        "りゃ": "RYA", "りゅ": "RYU", "りょ": "RYO",
        "ぎゃ": "GYA", "ぎゅ": "GYU", "ぎょ": "GYO",
        "じゃ": "JA", "じゅ": "JU", "じょ": "JO",
        "びゃ": "BYA", "びゅ": "BYU", "びょ": "BYO",
        "ぴゃ": "PYA", "ぴゅ": "PYU", "ぴょ": "PYO"
    };
    var katakanaMonographs = {
        "ア": "A", "イ": "I", "ウ": "U", "エ": "E", "オ": "O",
        "カ": "KA", "キ": "KI", "ク": "KU", "ケ": "KE", "コ": "KO",
        "サ": "SA", "シ": "SHI", "ス": "SU", "セ": "SE", "ソ": "SO",
        "タ": "TA", "チ": "CHI", "ツ": "TSU", "テ": "TE", "ト": "TO",
        "ナ": "NA", "ニ": "NI", "ヌ": "NU", "ネ": "NE", "ノ": "NO",
        "ハ": "HA", "ヒ": "HI", "フ": "FU", "ヘ": "HE", "ホ": "HO",
        "マ": "MA", "ミ": "MI", "ム": "MU", "メ": "ME", "モ": "MO",
        "ヤ": "YA", "ユ": "YU", "ヨ": "YO",
        "ラ": "RA", "リ": "RI", "ル": "RU", "レ": "RE", "ロ": "RO",
        "ワ": "WA", "ヰ": "WI", "ヱ": "WE",  "ヲ": "WO", "ン": "N",
        "ガ": "GA", "ギ": "GI", "グ": "GU", "ゲ": "GE", "ゴ": "GO",
        "ザ": "ZA", "ジ": "JI", "ズ": "ZU", "ゼ": "ZE", "ゾ": "ZO",
        "ダ": "DA", "ヂ": "DJI", "ヅ": "DZU", "デ": "DE", "ド": "DO",
        "バ": "BA", "ビ": "BI", "ブ": "BU", "ベ": "BE", "ボ": "BO",
        "パ": "PA", "ピ": "PI", "プ": "PU", "ペ": "PE", "ポ": "PO"
    };
    var katakanaDigraphs = {
        "アー": "Ā", "イー": "Ī", "ウー": "Ū", "エー": "Ē", "オー": "Ō",
        "カー": "KĀ", "キー": "KĪ", "クー": "KŪ", "ケー": "KĒ", "コー": "KŌ",
        "サー": "SĀ", "シー": "SHĪ", "スー": "SŪ", "セー": "SĒ", "ソー": "SŌ",
        "ター": "TĀ", "チー": "CHĪ", "ツー": "TSŪ", "テー": "TĒ", "トー": "TŌ",
        "ナー": "NĀ", "ニー": "NĪ", "ヌー": "NŪ", "ネー": "NĒ", "ノー": "NŌ",
        "ハー": "HĀ", "ヒー": "HĪ", "フー": "FŪ", "ヘー": "HĒ", "ホー": "HŌ",
        "マー": "MĀ", "ミー": "MĪ", "ムー": "MŪ", "メー": "MĒ", "モー": "MŌ",
        "ヤー": "YĀ", "ユー": "YŪ", "ヨー": "YŌ",
        "ラー": "RĀ", "リー": "RĪ", "ルー": "RŪ", "レー": "RĒ", "ロー": "RŌ",
        "ワー": "WĀ", "ヰー": "WĪ", "ヱー": "WĒ",  "ヲー": "WŌ", "ンー": "N",
        "ガー": "GĀ", "ギー": "GĪ", "グー": "GŪ", "ゲー": "GĒ", "ゴー": "GŌ",
        "ザー": "ZĀ", "ジー": "JĪ", "ズー": "ZŪ", "ゼー": "ZĒ", "ゾー": "ZŌ",
        "ダー": "DĀ", "ヂー": "DJĪ", "ヅー": "DZŪ", "デー": "DĒ", "ドー": "DŌ",
        "バー": "BĀ", "ビー": "BĪ", "ブー": "BŪ", "ベー": "BĒ", "ボー": "BŌ",
        "パー": "PĀ", "ピー": "PĪ", "プー": "PŪ", "ペー": "PĒ", "ポー": "PŌ",
        "キャ": "KYA", "キュ": "KYU", "キョ": "KYO",
        "シャ": "SHA", "シュ": "SHU", "ショ": "SHO",
        "チャ": "CHA", "チュ": "CHU", "チョ": "CHO",
        "ニャ": "NYA", "ニュ": "NYU", "ニョ": "NYO",
        "ヒャ": "HYA", "ヒュ": "HYU", "ヒョ": "HYO",
        "ミャ": "MYA", "ミュ": "MYU", "ミョ": "MYO",
        "リャ": "RYA", "リュ": "RYU", "リョ": "RYO",
        "ギャ": "GYA", "ギュ": "GYU", "ギョ": "GYO",
        "ジャ": "JA", "ジュ": "JU", "ジョ": "JO",
        "ビャ": "BYA", "ビュ": "BYU", "ビョ": "BYO",
        "ピャ": "PYA", "ピュ": "PYU", "ピョ": "PYO",
        "クヮ": "KWA", "クィ": "KWI", "クェ": "KWE", "クォ": "KWO",
        "グヮ": "GWA", "スィ": "SI",  "シェ": "SHE", "ズィ": "ZI", "ジェ": "JE",
        "ティ": "TI",  "トゥ": "TU",  "テュ": "TYU", "チェ": "CHE",
        "ツァ": "TSA", "ツィ": "TSI", "ツェ": "TSE", "ツォ": "TSO",
        "ディ": "DI" , "ドゥ": "DU",  "デュ": "DYU", "ホゥ": "HU",
        "ファ": "FA",  "フィ": "FI",  "フェ": "FE",  "フォ": "FO", "フュ": "FYU",
        "イィ": "YI",  "イェ": "YE",
        "ウィ": "WI",  "ウゥ": "WU", 	"ウェ": "WE",  "ウォ": "WO",
        "ヴァ": "VA",  "ヴィ": "VI",    "ヴ": "VU",  "ヴェ": "VE", "ヴォ": "VO", "ヴュ": "VYU"
    };
    var katakanaHalfwidths = {
        "ｱ": "ア", "ｲ": "イ", "ｳ": "ウ", "ｴ": "エ", "ｵ": "オ",
        "ｶ": "カ", "ｷ": "キ", "ｸ": "ク", "ｹ": "ケ", "ｺ": "コ",
        "ｻ": "サ", "ｼ": "シ", "ｽ": "ス", "ｾ": "セ", "ｿ": "ソ",
        "ﾀ": "タ", "ﾁ": "チ", "ﾂ": "ツ", "ﾃ": "テ", "ﾄ": "ト",
        "ﾅ": "ナ", "ﾆ": "ニ", "ﾇ": "ヌ", "ﾈ": "ネ", "ﾉ": "ノ",
        "ﾊ": "ハ", "ﾋ": "ヒ", "ﾌ": "フ", "ﾍ": "ヘ", "ﾎ": "ホ",
        "ﾏ": "マ", "ﾐ": "ミ", "ﾑ": "ム", "ﾒ": "メ", "ﾓ": "モ",
        "ﾔ": "ヤ", "ﾕ": "ユ", "ﾖ": "ヨ",
        "ﾗ": "ラ", "ﾘ": "リ", "ﾙ": "ル", "ﾚ": "レ", "ﾛ": "ロ",
        "ﾜ": "ワ", "ｦ": "ヲ", "ﾝ": "ン",
        "ｶﾞ": "ガ", "ｷﾞ": "ギ", "ｸﾞ": "グ", "ｹﾞ": "ゲ", "ｺﾞ": "ゴ",
        "ｻﾞ": "ザ", "ｼﾞ": "ジ", "ｽﾞ": "ズ", "ｾﾞ": "ゼ", "ｿﾞ": "ゾ",
        "ﾀﾞ": "ダ", "ﾁﾞ": "ヂ", "ﾂﾞ": "ヅ", "ﾃﾞ": "デ", "ﾄﾞ": "ド",
        "ﾊﾞ": "バ", "ﾋﾞ": "ビ", "ﾌﾞ": "ブ", "ﾍﾞ": "ベ", "ﾎﾞ": "ボ",
        "ﾊﾟ": "パ", "ﾋﾟ": "ピ", "ﾌﾟ": "プ", "ﾍﾟ": "ペ", "ﾎﾟ": "ポ",
        "ｧ": "ァ", "ｨ": "ィ", "ｩ": "ゥ", "ｪ": "ェ", "ｫ": "ォ",
        "ｬ": "ャ", "ｭ": "ュ", "ｮ": "ョ",
        "ｯ": "ッ", "ｰ": "ー"
    };
    var katakanaHalfwidthsCombined = {
        "ｶﾞ": "ガ", "ｷﾞ": "ギ", "ｸﾞ": "グ", "ｹﾞ": "ゲ", "ｺﾞ": "ゴ",
        "ｻﾞ": "ザ", "ｼﾞ": "ジ", "ｽﾞ": "ズ", "ｾﾞ": "ゼ", "ｿﾞ": "ゾ",
        "ﾀﾞ": "ダ", "ﾁﾞ": "ヂ", "ﾂﾞ": "ヅ", "ﾃﾞ": "デ", "ﾄﾞ": "ド",
        "ﾊﾞ": "バ", "ﾋﾞ": "ビ", "ﾌﾞ": "ブ", "ﾍﾞ": "ベ", "ﾎﾞ": "ボ",
        "ﾊﾟ": "パ", "ﾋﾟ": "ピ", "ﾌﾟ": "プ", "ﾍﾟ": "ペ", "ﾎﾟ": "ポ"
    };
    function keysToRegex(obj) {
        return new RegExp(Object.keys(obj).join('|'), "g");
    }
    var hiraganaMonographsRegex = keysToRegex(hiraganaMonographs);
    var hiraganaDigraphsRegex = keysToRegex(hiraganaDigraphs);
    var katakanaMonographsRegex = keysToRegex(katakanaMonographs);
    var katakanaDigraphsRegex = keysToRegex(katakanaDigraphs);
    var katakanaHalfwidthsCombinedRegex = keysToRegex(katakanaHalfwidthsCombined);
    var katakanaHalfwidthsRegex = keysToRegex(katakanaHalfwidths);
    function fromKana(str) {
        str = bulkReplace(str, katakanaHalfwidthsCombinedRegex, katakanaHalfwidthsCombined);
        str = bulkReplace(str, katakanaHalfwidthsRegex, katakanaHalfwidths);
        str = bulkReplace(str, hiraganaDigraphsRegex, hiraganaDigraphs);
        str = bulkReplace(str, katakanaDigraphsRegex, katakanaDigraphs);
        str = bulkReplace(str, hiraganaMonographsRegex, hiraganaMonographs);
        str = bulkReplace(str, katakanaMonographsRegex, katakanaMonographs);
        str = str.replace(/[っッ]C/g, "TC").replace(/[っッ](.)/g, "$1$1");
        str = str.replace(/[NM]'([^YAEIOU]|$)/g, "N$1");
        str = str.replace(/Aー/g, "Ā");
        str = str.replace(/Iー/g, "Ī");
        str = str.replace(/Uー/g, "Ū");
        str = str.replace(/Eー/g, "Ē");
        str = str.replace(/Oー/g, "Ō");
        return str;
    };
    if("{{Vocabulary-Kana}}" === "{{Vocabulary-Kanji}}") {
        const kana = document.getElementById("kana");
        kana.textContent = fromKana("{{Vocabulary-Kana}}").toLowerCase();
        if(katakanaMonographsRegex.test("{{Vocabulary-Kana}}") && !hiraganaMonographsRegex.test("{{Vocabulary-Kana}}")) {
            kana.textContent += " (katakana)";
        }
        else if(hiraganaMonographsRegex.test("{{Vocabulary-Kana}}") && !katakanaMonographsRegex.test("{{Vocabulary-Kana}}")) {
            kana.textContent += " (hiragana)";
        }
    }
</script>

<div style="font-size: 16px; ">{{Vocabulary-Pos}}</div>

<canvas id="kanjiCanvas" width="800" height="200"></canvas><br/>
<button onclick="undo()">Undo</button><button onclick="erase()">Clear</button>
<script>
    var strokes = [];
    function erase() {
        const canvas = document.getElementById("kanjiCanvas");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        strokes.length = 0;
    }
    function undo() {
        const canvas = document.getElementById("kanjiCanvas");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        strokes.splice(strokes.length - 1, 1);
        for(const stroke of strokes) {
            const xs = stroke[0], ys = stroke[1], length = xs.length;
            for(let i = 1; i < length; i += 1) {
                ctx.beginPath();
                ctx.moveTo(xs[i - 1], ys[i - 1]);
                ctx.lineTo(xs[i], ys[i]);
                ctx.stroke();
            }
        }
    }
    var kanjiCanvasAnimationFrame;
    if(kanjiCanvasAnimationFrame) window.cancelAnimationFrame(kanjiCanvasAnimationFrame);
    (function() {
        const canvas = document.getElementById("kanjiCanvas");
        const ctx = canvas.getContext("2d");
        ctx.lineWidth = 5;
        ctx.strokeStyle = "white";
        ctx.lineCap = "round";
        let mouseIsPressed = false, mouseReleased = false, mouseX = mouseY = xPoint = yPoint = 0;
        function getRelativePos(e, isTouch = false) {
            const rect = canvas.getBoundingClientRect();
            if(isTouch) {
                const touch = e.touches[0] || e.changedTouches[0];
                return {
                    x: touch.clientX - rect.left,
                    y: touch.clientY - rect.top
                };
            }
            else {
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
        }
        canvas.onmousedown = e => {
            if(e.button === 0) {
                const { x, y } = getRelativePos(e);
                mouseIsPressed = true;
                strokes.push([[x], [y]]);
                xPoint = mouseX = x;
                yPoint = mouseY = y;
            }
        };
        canvas.onmouseup = e => {
            if(e.button === 0) {
                mouseIsPressed = false;
                mouseReleased = true;
            }
        };
        canvas.onmousemove = e => {
            const { x, y } = getRelativePos(e);
            mouseX = x;
            mouseY = y;
        };
        canvas.addEventListener("touchstart", e => {
            e.preventDefault();
            const { x, y } = getRelativePos(e, true);
            mouseIsPressed = true;
            strokes.push([[x], [y]]);
            xPoint = mouseX = x;
            yPoint = mouseY = y;
        }, { passive: false });
        canvas.addEventListener("touchend", e => {
            e.preventDefault();
            mouseIsPressed = false;
            mouseReleased = true;
        }, { passive: false });
        canvas.addEventListener("touchmove", e => {
            e.preventDefault();
            const { x, y } = getRelativePos(e, true);
            mouseX = x;
            mouseY = y;
        }, { passive: false });
        let ptime = 0;
        function draw(time) {
            kanjiCanvasAnimationFrame = window.requestAnimationFrame(draw);
            const dt = time - ptime;
            ptime = time;
            if(strokes.length > 0) {
                const currentStroke = strokes[strokes.length - 1],
                    lastStroke = currentStroke[0].length - 1,
                    xLast = currentStroke[0][lastStroke],
                    yLast = currentStroke[1][lastStroke];
                if(mouseIsPressed) {
                    if(xLast !== xPoint || yLast !== yPoint) {
                        currentStroke[0].push(xPoint);
                        currentStroke[1].push(yPoint);
                        ctx.beginPath();
                        ctx.moveTo(xLast, yLast);
                        ctx.lineTo(xPoint, yPoint);
                        ctx.stroke();
                    }
                    const SMOOTHING = 0.001 ** 0.00482218493601;
                    xPoint = mouseX - (mouseX - xPoint) * Math.exp((SMOOTHING - 1) * dt);
                    yPoint = mouseY - (mouseY - yPoint) * Math.exp((SMOOTHING - 1) * dt);
                }
                if(mouseReleased) {
                    currentStroke[0].push(mouseX);
                    currentStroke[1].push(mouseY);
                    ctx.beginPath();
                    ctx.moveTo(xLast, yLast);
                    ctx.lineTo(mouseX, mouseY);
                    ctx.stroke();
                }
            }
            mouseReleased = false;
        }
        kanjiCanvasAnimationFrame = window.requestAnimationFrame(draw);
    })();
</script>

<br/><br/><br/><br/><br/>
<div id="example-sentence" class="japanese" style="font-size:40px;">{{furigana:Sentence-Clozed}}</div>
<div style="font-size: 20px; ">{{Vocabulary-English}}</div>